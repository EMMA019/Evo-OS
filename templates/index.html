<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evo Studio v2.6 (Retro IDE)</title>
    
    <!-- CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.min.js"></script>
    <!-- „Éï„Ç©„É≥„Éà: DotGothic16 (Êó•Êú¨Ë™û) & Press Start 2P (Ëã±Êï∞) -->
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Press+Start+2P&display=swap" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">

    <style>
        /* „Ç´„É©„Éº„Éë„É¨„ÉÉ„Éà (ËêΩ„Å°ÁùÄ„ÅÑ„Åü„É¨„Éà„É≠„ÉÄ„Éº„ÇØ) */
        :root {
            --bg-main: #282c34;
            --bg-panel: #21252b;
            --bg-header: #181a1f;
            --accent-primary: #98c379; /* „É¨„Éà„É≠„Ç∞„É™„Éº„É≥ */
            --accent-secondary: #61afef; /* „É¨„Éà„É≠„Éñ„É´„Éº */
            --text-main: #abb2bf;
            --text-highlight: #ffffff;
            --border-color: #3e4451;
        }

        body { 
            /* Êó•Êú¨Ë™û„ÅØ DotGothic16, Ëã±Êï∞Â≠ó„ÅØ Press Start 2P */
            font-family: 'Press Start 2P', 'DotGothic16', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
            font-size: 12px;
            line-height: 1.5;
            overflow: hidden;
        }

        .jp-font {
            font-family: 'DotGothic16', sans-serif;
            font-weight: bold;
        }

        /* UI„Éë„Éº„ÉÑ */
        .retro-btn {
            background-color: var(--bg-panel);
            color: var(--accent-secondary);
            border: 1px solid var(--border-color);
            transition: all 0.1s;
            font-family: 'DotGothic16', sans-serif;
            cursor: pointer;
        }
        .retro-btn:hover {
            background-color: var(--border-color);
            color: var(--text-highlight);
        }
        .retro-btn:active {
            transform: translateY(2px);
        }
        .retro-btn.primary {
            background-color: var(--accent-primary);
            color: #1e2227;
            border: none;
        }
        .retro-btn.primary:hover {
            opacity: 0.9;
        }

        .retro-input {
            background-color: #1e2227;
            border: 1px solid var(--border-color);
            color: var(--text-highlight);
            font-family: 'DotGothic16', sans-serif;
            font-size: 14px;
        }
        .retro-input:focus {
            outline: none;
            border-color: var(--accent-secondary);
        }

        /* „Çπ„ÇØ„É≠„Éº„É´„Éê„Éº */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-main); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #5c6370; }

        /* „Éï„Ç°„Ç§„É´„É™„Çπ„Éà */
        .file-item {
            border-bottom: 1px solid var(--bg-header);
            transition: background 0.1s;
        }
        .file-item:hover { 
            background-color: var(--bg-header); 
            color: var(--text-highlight);
            cursor: pointer; 
        }
        .file-item.active { 
            background-color: #323844; 
            color: var(--accent-secondary); 
            border-left: 3px solid var(--accent-secondary);
        }

        /* „Éè„Ç§„É©„Ç§„ÉàË™øÊï¥ */
        pre code.hljs {
            font-family: 'Consolas', 'Monaco', monospace; /* „Ç≥„Éº„Éâ„ÅØË¶ã„ÇÑ„Åô„ÅïÈáçË¶ñ */
            font-size: 14px;
            line-height: 1.6;
            background: transparent;
        }
    </style>
</head>
<body class="h-screen flex flex-col">

    {% raw %}
    <div id="app" class="h-full flex flex-col">
        
        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
        <header class="h-12 border-b border-gray-700 flex items-center px-4 justify-between shrink-0 bg-[#181a1f]">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-terminal text-[#98c379] text-xl"></i>
                <div class="flex flex-col">
                    <span class="font-bold text-[14px] tracking-wide text-white jp-font leading-tight">Evo Studio <span class="text-[10px] text-[#61afef]">v2.6</span></span>
                    <span class="text-[8px] text-gray-500">AI AGENT IDE</span>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div v-if="activeKit" class="text-[10px] px-2 py-1 bg-[#323844] text-[#98c379] border border-gray-600 rounded flex items-center gap-2 jp-font">
                    <i class="fa-solid fa-microchip"></i> {{ activeKit }}
                </div>
                <a href="/download" class="text-[11px] px-3 py-1 retro-btn rounded no-underline flex items-center gap-2 jp-font">
                    <i class="fa-solid fa-download"></i> ‰øùÂ≠ò
                </a>
            </div>
        </header>

        <!-- „É°„Ç§„É≥„ÉØ„Éº„ÇØ„Çπ„Éö„Éº„Çπ -->
        <div class="flex-1 flex overflow-hidden">
            
            <!-- Â∑¶„Çµ„Ç§„Éâ„Éê„Éº: „Éï„Ç°„Ç§„É´ -->
            <div class="w-64 border-r border-gray-700 flex flex-col shrink-0 bg-[#21252b]">
                <div class="p-3 text-[11px] font-bold text-gray-400 border-b border-gray-700 flex justify-between items-center jp-font">
                    <span><i class="fa-regular fa-folder-open mr-1"></i> „Éó„É≠„Ç∏„Çß„ÇØ„Éà</span>
                    <button @click="refreshFiles" class="hover:text-white transition"><i class="fa-solid fa-sync"></i></button>
                </div>
                <div class="flex-1 overflow-y-auto">
                    <div v-for="file in files" :key="file" 
                         @click="loadFile(file)"
                         class="file-item px-4 py-2 text-[12px] flex items-center gap-2"
                         :class="{ 'active': currentFile === file }">
                        <i class="fa-regular fa-file-code text-gray-500"></i> <span class="truncate">{{ file }}</span>
                    </div>
                </div>
                
                <!-- „Çπ„ÉÜ„Éº„Çø„Çπ„Éë„Éç„É´ -->
                <div class="p-3 border-t border-gray-700 bg-[#1e2227]">
                    <div class="text-[10px] font-bold text-gray-500 mb-2 jp-font">„Çπ„ÉÜ„Éº„Çø„Çπ</div>
                    <div class="grid grid-cols-2 gap-2 text-[10px] jp-font">
                        <div class="bg-[#282c34] p-1 rounded border border-gray-700 text-center">
                            <div class="text-[#61afef]">„Éï„Çß„Éº„Ç∫</div>
                            <div class="text-white">{{ stats.currentPhase }}/{{ stats.totalPhases }}</div>
                        </div>
                        <div class="bg-[#282c34] p-1 rounded border border-gray-700 text-center">
                            <div class="text-[#98c379]">‰øÆÂæ©</div>
                            <div class="text-white">{{ stats.l1 + stats.l2 }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ‰∏≠Â§Æ: „Ç®„Éá„Ç£„Çø„Ç®„É™„Ç¢ -->
            <div class="flex-1 flex flex-col min-w-0 bg-[#282c34]">
                <!-- „Çø„Éñ„Éê„Éº -->
                <div class="h-10 flex border-b border-gray-700 bg-[#21252b]">
                    <button @click="viewMode='code'" class="px-5 text-[11px] flex items-center gap-2 jp-font border-r border-gray-700 transition"
                         :class="viewMode==='code' ? 'bg-[#282c34] text-[#61afef] border-t-2 border-t-[#61afef]' : 'text-gray-500 hover:text-white hover:bg-[#2c313a]'">
                        <i class="fa-solid fa-code"></i> „Ç≥„Éº„Éâ
                    </button>
                    <button @click="viewMode='preview'" class="px-5 text-[11px] flex items-center gap-2 jp-font border-r border-gray-700 transition"
                         :class="viewMode==='preview' ? 'bg-[#282c34] text-[#61afef] border-t-2 border-t-[#61afef]' : 'text-gray-500 hover:text-white hover:bg-[#2c313a]'">
                        <i class="fa-solid fa-play"></i> „Éó„É¨„Éì„É•„Éº
                    </button>
                    <div class="flex-1"></div>
                    <span v-if="currentFile" class="px-4 text-[11px] text-gray-500 self-center font-mono">{{ currentFile }}</span>
                </div>

                <!-- „Ç≥„É≥„ÉÜ„É≥„ÉÑË°®Á§∫ -->
                <div class="flex-1 relative overflow-hidden">
                    <div v-show="viewMode==='code'" class="absolute inset-0 overflow-auto">
                        <pre><code class="language-python h-full" ref="codeBlock">{{ fileContent }}</code></pre>
                    </div>
                    <div v-show="viewMode==='preview'" class="absolute inset-0 bg-white">
                        <iframe v-if="previewUrl" :src="previewUrl" class="w-full h-full border-none"></iframe>
                        <div v-else class="flex flex-col items-center justify-center h-full text-[#333]">
                            <i class="fa-solid fa-eye-slash text-4xl mb-4 text-gray-300"></i>
                            <span class="text-[12px] font-bold text-gray-400 jp-font">„Éó„É¨„Éì„É•„Éº„Åß„Åç„Åæ„Åõ„Çì</span>
                        </div>
                    </div>
                </div>

                <!-- ‰∏ãÈÉ®: „Ç≥„É≥„ÇΩ„Éº„É´/„ÉÅ„É£„ÉÉ„Éà -->
                <div class="h-1/3 min-h-[150px] border-t border-gray-700 flex flex-col bg-[#21252b]">
                    <div class="h-8 px-4 flex items-center justify-between bg-[#1b1d23] border-b border-gray-700">
                        <span class="text-[11px] font-bold text-[#98c379] jp-font"><i class="fa-solid fa-terminal mr-2"></i>„Ç∑„Çπ„ÉÜ„É†„É≠„Ç∞ / „ÉÅ„É£„ÉÉ„Éà</span>
                        <button @click="reset" class="text-[10px] text-gray-500 hover:text-[#e06c75] jp-font"><i class="fa-solid fa-trash mr-1"></i>„É≠„Ç∞Ê∂àÂéª</button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4 font-mono text-[12px] space-y-3 bg-[#282c34]" ref="chatLog">
                        <div v-for="(msg, i) in messages" :key="i" class="flex gap-3">
                            <div class="font-bold shrink-0 w-12 text-right" :class="{'text-[#61afef]': msg.role==='user', 'text-[#98c379]': msg.role!=='user'}">
                                {{ msg.role === 'user' ? 'YOU' : 'EVO' }}
                            </div>
                            <div class="text-[#abb2bf] flex-1 jp-font leading-relaxed border-l-2 border-gray-700 pl-3" v-html="formatMessage(msg.content)"></div>
                        </div>
                    </div>
                    
                    <!-- ÂÖ•Âäõ„Ç®„É™„Ç¢ -->
                    <div class="p-3 border-t border-gray-700 flex gap-3 bg-[#21252b]">
                        <div class="relative flex-1">
                            <i class="fa-solid fa-chevron-right absolute left-3 top-3 text-gray-500 text-xs"></i>
                            <input v-model="prompt" @keydown.enter="generate" 
                                class="w-full retro-input pl-8 pr-4 py-2.5 rounded shadow-inner"
                                placeholder="Evo„Å∏„ÅÆÊåáÁ§∫„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ... (‰æã: MIT„É©„Ç§„Çª„É≥„ÇπÁ¥π‰ªã„Éñ„É≠„Ç∞„Çí‰Ωú„Å£„Å¶)">
                        </div>
                        <button @click="generate" :disabled="loading" class="retro-btn primary px-6 py-2 rounded font-bold shadow-lg flex items-center gap-2">
                            <i v-if="loading" class="fa-solid fa-spinner fa-spin"></i>
                            <span v-else>ÂÆüË°å</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endraw %}

    <script>
        window.onload = () => {
            if (typeof Vue === 'undefined' || !Vue.createApp) {
                console.error("CRITICAL: Vue.js library failed to load even after window load. Check network.");
                alert("Vue.js„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ");
                return; 
            }
            
            const { createApp, ref, nextTick, onMounted } = Vue; 

            createApp({
                setup() {
                    const prompt = ref('');
                    const messages = ref([]);
                    const loading = ref(false);
                    const viewMode = ref('code'); 
                    const files = ref([]);
                    const currentFile = ref('');
                    const fileContent = ref('');
                    const previewUrl = ref('');
                    const chatLog = ref(null);
                    const codeBlock = ref(null);
                    const stats = ref({ currentPhase: 0, totalPhases: 0, l1: 0, l2: 0, l3: 0 });
                    const activeKit = ref('');

                    const scrollToBottom = () => nextTick(() => { if(chatLog.value) chatLog.value.scrollTop = chatLog.value.scrollHeight; });
                    const formatMessage = (content) => content ? content.replace(/\n/g, '<br>') : "";

                    const speak = (text) => {
                        if ('speechSynthesis' in window) {
                            const uttr = new SpeechSynthesisUtterance(text);
                            uttr.lang = 'ja-JP'; 
                            uttr.rate = 1.0;
                            window.speechSynthesis.speak(uttr);
                        }
                    };

                    const refreshFiles = async () => {
                        try {
                            const res = await fetch('/files');
                            const data = await res.json();
                            files.value = data.files || [];
                        } catch (e) { console.error(e); }
                    };

                    const loadFile = async (filename) => {
                        currentFile.value = filename;
                        try {
                            const res = await fetch(`/files/content?filename=${filename}`);
                            const data = await res.json();
                            fileContent.value = data.content || "";
                            viewMode.value = 'code';
                            
                            nextTick(() => {
                                if (codeBlock.value) {
                                    codeBlock.value.removeAttribute('data-highlighted');
                                    hljs.highlightElement(codeBlock.value); 
                                }
                            });

                            if (filename.endsWith('.html')) {
                                previewUrl.value = `/preview/${filename}`;
                            } else if (filename === 'app.py' || filename === 'main.py') {
                                previewUrl.value = `/preview/index.html`; 
                            }
                        } catch (e) { console.error(e); }
                    };

                    const generate = async () => {
                        if (!prompt.value || loading.value) return;
                        const userPrompt = prompt.value;
                        prompt.value = '';
                        messages.value.push({ role: 'user', content: userPrompt });
                        loading.value = true;
                        scrollToBottom();

                        try {
                            const res = await fetch('/generate', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ prompt: userPrompt })
                            });
                            
                            if (!res.ok) {
                                const errorText = await res.text();
                                throw new Error(`„Çµ„Éº„Éê„Éº„Ç®„É©„Éº (${res.status}): ${errorText.substring(0, 100)}...`);
                            }
                            
                            const data = await res.json();

                            if (data.stats) stats.value = data.stats;
                            if (data.kit_used) activeKit.value = data.kit_used;
                            if (data.logs) data.logs.forEach(log => messages.value.push({ role: 'system', content: log }));
                            
                            messages.value.push({ role: 'ai', content: data.message || "ÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ" });

                            await refreshFiles();
                            if (data.main_file) loadFile(data.main_file);

                            speak("Âá¶ÁêÜ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ");

                        } catch (e) {
                            messages.value.push({ role: 'ai', content: `üí• „Ç®„É©„Éº: ${e.message}` });
                        } finally {
                            loading.value = false;
                            scrollToBottom();
                        }
                    };

                    const reset = () => location.reload();

                    onMounted(() => {
                        refreshFiles();
                        messages.value.push({ role: 'system', content: 'Evo Studio Ëµ∑ÂãïÂÆå‰∫Ü„ÄÇ' });
                    });

                    return { 
                        prompt, messages, loading, viewMode, files, currentFile, fileContent, previewUrl,
                        chatLog, codeBlock, stats, activeKit, generate, refreshFiles, loadFile, reset, formatMessage 
                    };
                }
            }).mount('#app');
        };
    </script>
</body>
</html>